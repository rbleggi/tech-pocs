pipeline {
    agent {
        docker {
            image 'jenkins-agent:java-docker-git'
            args '-u root -v /var/run/docker.sock:/var/run/docker.sock --privileged --add-host=k3s:host-gateway --add-host=host-gateway:host-gateway'
        }
    }

    options {
        timeout(time: 15, unit: 'MINUTES')
        disableConcurrentBuilds()
    }

    triggers {
        pollSCM('H/1 * * * *')
    }

    environment {
        DOCKER_IMAGE = 'tech-pocs/java-devops-app'
        DOCKER_TAG = "${BUILD_NUMBER}"
        WORKSPACE = "${env.WORKSPACE}/java/devops"
        KUBECONFIG_ORIGINAL = "/tmp/kubeconfig.yaml"
        KUBECONFIG_MODIFIED = "/tmp/kubeconfig-modified.yaml"
        KUBECONFIG = "${KUBECONFIG_MODIFIED}"
        HELM_CHART_PATH = "${WORKSPACE}/helm/sample-app"
        OPENTOFU_DIR = "${WORKSPACE}/opentofu"
        INFRA_NAMESPACE = "infrastructure"
        APP_NAMESPACE = "applications"
    }

    stages {
        stage('Verify Agent') {
            steps {
                echo "Running on agent: ${env.NODE_NAME}"
                echo "This build is NOT running on the built-in node"
                sh 'hostname'
            }
        }

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Test & Build') {
            steps {
                echo "Running Maven tests"
                sh '''
                cd java/devops
                mvn clean test
                cd ${WORKSPACE}
                docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} -f Dockerfile .
                docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_IMAGE}:latest
                '''
            }
        }

        stage('Fetch Kubeconfig') {
            steps {
                sh '''
                # Create directory for kubeconfig
                mkdir -p /tmp
                
                # Try to copy kubeconfig from k3s container
                echo "Attempting to fetch kubeconfig from k3s container..."
                docker cp k3s:/config/kubeconfig.yaml ${KUBECONFIG_ORIGINAL} || echo "Failed to copy from container"
                
                # If that didn't work, try to get it from the host path where the k3s volume is mounted
                if [ ! -s ${KUBECONFIG_ORIGINAL} ]; then
                  echo "Attempting to find kubeconfig in mounted volumes..."
                  find / -name kubeconfig.yaml -type f 2>/dev/null || echo "No kubeconfig found in system"
                  
                  # As a last resort, create a minimal test kubeconfig for diagnostics
                  if [ ! -s ${KUBECONFIG_ORIGINAL} ]; then
                    echo "Creating temporary test kubeconfig for diagnostics..."
                    cat > ${KUBECONFIG_ORIGINAL} << EOF
apiVersion: v1
kind: Config
clusters:
- name: k3s
  cluster:
    server: https://k3s:6443
contexts:
- name: default
  context:
    cluster: k3s
    user: default
current-context: default
users:
- name: default
  user:
    client-certificate-data: dummy
EOF
                  fi
                fi
                
                # Check kubeconfig was obtained and modify
                if [ -s ${KUBECONFIG_ORIGINAL} ]; then
                  echo "Kubeconfig found! Modifying..."
                  cat ${KUBECONFIG_ORIGINAL}
                  sed 's|https://k3s:6443|https://host-gateway:6443|g' ${KUBECONFIG_ORIGINAL} > ${KUBECONFIG_MODIFIED}
                  yq -i '(.clusters[].cluster) |= (. + {"insecure-skip-tls-verify": true} | del(."certificate-authority-data") | del(."certificate-authority"))' ${KUBECONFIG_MODIFIED}
                  echo "Final kubeconfig:"
                  cat ${KUBECONFIG_MODIFIED}
                else
                  echo "Failed to get kubeconfig file!"
                  exit 1
                fi
                '''
            }
        }

        stage('Provision Infra (OpenTofu)') {
            steps {
                sh '''
                cd ${OPENTOFU_DIR}
                tofu init
                tofu import kubernetes_namespace.infrastructure infrastructure || true
                tofu import kubernetes_namespace.applications applications || true
                tofu validate
                tofu plan -var="kubeconfig_path=${KUBECONFIG_MODIFIED}" -out=tfplan
                tofu apply -auto-approve tfplan
                '''
            }
        }
    }

    post {
        always {
            echo "Build completed on agent: ${env.NODE_NAME}"
        }
        success {
            echo "Build and deployment succeeded!"
        }
        failure {
            echo "Build or deployment failed!"
        }
    }
}
