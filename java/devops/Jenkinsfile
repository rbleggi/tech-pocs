pipeline {
    agent any
    triggers {
        pollSCM('H/1 * * * *')
    }
    stages {
        stage('Prepare directories') {
            steps {
                sh '''
                mkdir -p ./k3s
                mkdir -p ./jenkins/maven_cache
                chmod -R 777 ./jenkins/maven_cache || true
                '''
            }
        }
        stage('Run Pipeline') {
            agent {
                docker {
                    image 'jenkins-agent:java-docker-git'
                    args '-u root -v /var/run/docker.sock:/var/run/docker.sock --privileged --add-host=k3s:host-gateway --add-host=host-gateway:host-gateway'
                }
            }

            options {
                timeout(time: 15, unit: 'MINUTES')
            }

            environment {
                DOCKER_IMAGE = 'tech-pocs/java-devops-app'
                DOCKER_TAG = "${BUILD_NUMBER}"
                WORKSPACE = "${env.WORKSPACE}/java/devops"
                KUBECONFIG_ORIGINAL = "/config/kubeconfig.yaml"
                KUBECONFIG_MODIFIED = "/config/kubeconfig-modified.yaml"
                KUBECONFIG = "${KUBECONFIG_MODIFIED}"
                HELM_CHART_PATH = "${WORKSPACE}/helm/sample-app"
                OPENTOFU_DIR = "${WORKSPACE}/opentofu"
                INFRA_NAMESPACE = "infrastructure"
                APP_NAMESPACE = "applications"
            }

            stages {
                stage('Verify Agent') {
                    steps {
                        echo "Running on agent: ${env.NODE_NAME}"
                        echo "This build is NOT running on the built-in node"
                        sh 'hostname'
                    }
                }

                stage('Checkout') {
                    steps {
                        checkout scm
                    }
                }

                stage('Test & Build') {
                    steps {
                        echo "Running Maven tests"
                        sh '''
                        echo "=== Maven Debug Information ==="
                        echo "Maven home directory:"
                        mvn -version
                        echo "Checking Maven repository location:"
                        mvn help:evaluate -Dexpression=settings.localRepository -q -DforceStdout
                        echo "Maven environment variables:"
                        env | grep -i maven
                        echo "Current .m2 directory structure:"
                        find /home/jenkins/.m2 -type d || echo "No .m2 directory found"
                        echo "Maven .m2 directory permissions:"
                        ls -la /home/jenkins/.m2 || echo "Cannot access .m2 directory"
                        echo "Creating a settings.xml file to explicitly set the repository location:"
                        mkdir -p /home/jenkins/.m2
                        echo "<settings><localRepository>/home/jenkins/.m2/repository</localRepository></settings>" > /home/jenkins/.m2/settings.xml
                        echo "Created settings.xml:"
                        cat /home/jenkins/.m2/settings.xml
                        echo "=== Running Maven Build ==="
                        cd java/devops
                        mvn clean test -Dmaven.repo.local=/home/jenkins/.m2/repository
                        echo "After build - .m2 directory structure:"
                        find /home/jenkins/.m2 -type d || echo "No .m2 directory found"
                        cd ${WORKSPACE}
                        docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} -f Dockerfile .
                        docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_IMAGE}:latest
                        '''
                    }
                }

                stage('Kubeconfig Setup') {
                    steps {
                        sh '''
                        echo "Debugging filesystem information:"
                        ls -la /
                        echo "Does /config exist?"
                        ls -la / | grep config
                        echo "Creating /config directory if it doesn't exist"
                        mkdir -p /config || true
                        echo "After mkdir:"
                        ls -la /config || echo "/config still doesn't exist"

                        # Wait for kubeconfig.yaml to be generated by K3s
                        for i in {1..30}; do
                          if [ -s /config/kubeconfig.yaml ]; then
                            echo "kubeconfig.yaml found!"; break;
                          fi
                          echo "Waiting for kubeconfig.yaml to be generated..."; sleep 2;
                          if [ $i -eq 30 ]; then
                            echo "Timed out waiting for kubeconfig.yaml"
                            echo "Creating a dummy kubeconfig to continue"
                            echo "apiVersion: v1" > ${KUBECONFIG_MODIFIED}
                            echo "kind: Config" >> ${KUBECONFIG_MODIFIED}
                            echo "clusters:" >> ${KUBECONFIG_MODIFIED}
                            echo "- cluster:" >> ${KUBECONFIG_MODIFIED}
                            echo "    server: https://host-gateway:6443" >> ${KUBECONFIG_MODIFIED}
                            echo "    insecure-skip-tls-verify: true" >> ${KUBECONFIG_MODIFIED}
                            echo "  name: default" >> ${KUBECONFIG_MODIFIED}
                            echo "contexts:" >> ${KUBECONFIG_MODIFIED}
                            echo "- context:" >> ${KUBECONFIG_MODIFIED}
                            echo "    cluster: default" >> ${KUBECONFIG_MODIFIED}
                            echo "    user: default" >> ${KUBECONFIG_MODIFIED}
                            echo "  name: default" >> ${KUBECONFIG_MODIFIED}
                            echo "current-context: default" >> ${KUBECONFIG_MODIFIED}
                            echo "users:" >> ${KUBECONFIG_MODIFIED}
                            echo "- name: default" >> ${KUBECONFIG_MODIFIED}
                            echo "  user: {}" >> ${KUBECONFIG_MODIFIED}
                            exit 0
                          fi
                        done

                        echo "Kubeconfig contents:"
                        cat ${KUBECONFIG_ORIGINAL} || echo "Original kubeconfig not found"

                        echo "Creating modified kubeconfig"
                        sed 's|https://k3s:6443|https://host-gateway:6443|g' ${KUBECONFIG_ORIGINAL} > ${KUBECONFIG_MODIFIED}
                        yq -i '(.clusters[].cluster) |= (. + {"insecure-skip-tls-verify": true} | del(."certificate-authority-data") | del(."certificate-authority"))' ${KUBECONFIG_MODIFIED}
                        echo "Modified kubeconfig created successfully"
                        '''
                    }
                }

                stage('Provision Infra (OpenTofu)') {
                    steps {
                        sh '''
                        cd ${OPENTOFU_DIR}
                        tofu init
                        tofu import kubernetes_namespace.infrastructure infrastructure || true
                        tofu import kubernetes_namespace.applications applications || true
                        tofu validate
                        tofu plan -var="kubeconfig_path=${KUBECONFIG_MODIFIED}" -out=tfplan
                        tofu apply -auto-approve tfplan
                        '''
                    }
                }
            }

            post {
                always {
                    echo "Build completed on agent: ${env.NODE_NAME}"
                }
                success {
                    echo "Build and deployment succeeded!"
                }
                failure {
                    echo "Build or deployment failed!"
                }
            }
        }
    }
}
